<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2fcf5">
    <title>è–ªèµ„æ£®æ—</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi6Iaq6LWE5qOu5p6XIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmMmZjZjUiLCJkaXNwbGF5IjoiZnVsbHNjcmVlbiIsImljb25zIjpW1dXX0=">
    
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', '"Nunito"', 'system-ui', 'sans-serif'],
                        cute: ['"ZCOOL KuaiLe"', 'cursive'],
                    },
                    colors: {
                        forest: { 
                            50: '#f2fcf5', 100: '#e1f8e8', 200: '#c3efd2', 
                            300: '#94e0b3', 400: '#5cc98d', 500: '#4a7c59', 
                            600: '#3a6346', 700: '#2d5036', 800: '#24402d', 900: '#1d3325' 
                        },
                        earth: { 100: '#fdf3e7', 400: '#d4a76a', 500: '#a86f4c', 600: '#8b5a3e' },
                        sky: { day: '#e0f7fa', noon: '#b3e5fc', dusk: '#fff3e0', night: '#263238' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'leaf-fall': 'leafFall 12s linear infinite',
                        'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } },
                        leafFall: {
                            '0%': { transform: 'translateY(-10vh) rotate(0deg) translateX(0)', opacity: '0' },
                            '10%': { opacity: '0.8' },
                            '100%': { transform: 'translateY(110vh) rotate(720deg) translateX(50px)', opacity: '0' }
                        },
                        pop: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none; }
        body { 
            background-color: #f2fcf5; 
            color: #2c3e50; 
            overflow: hidden; 
            font-size: 16px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* çœŸå®æ—¶é—´å¤©ç©ºç³»ç»Ÿ (æŸ”å’Œç‰ˆ) */
        .sky-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10;
            background: linear-gradient(to bottom, var(--sky-top), var(--sky-bottom));
            transition: --sky-top 10s, --sky-bottom 10s; 
            will-change: background;
        }

        /* æ£®æ—èƒŒæ™¯æ’ç”» */
        .forest-bg {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50%; z-index: -5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%234a7c59' fill-opacity='0.2' d='M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover; background-position: bottom; pointer-events: none;
        }
        .forest-fg {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35%; z-index: -4;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%232d5036' fill-opacity='0.4' d='M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover; background-position: bottom; pointer-events: none;
        }

        /* æ²»æ„ˆç³»æ¯›ç»ç’ƒ */
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(100, 140, 110, 0.1);
            color: #2c3e50;
        }
        
        .modal-overlay { background: rgba(45, 80, 54, 0.3); backdrop-filter: blur(4px); }

        /* å†œç”°æ ·å¼ä¼˜åŒ– */
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
            gap: 12px;
            width: 100%;
        }
        @media (max-width: 640px) { .farm-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; } }
        @media (max-width: 380px) { .farm-grid { grid-template-columns: repeat(3, 1fr); } }

        .farm-plot {
            aspect-ratio: 1; position: relative; border-radius: 16px;
            background: #e8dccc;
            box-shadow: inset 0 4px 10px rgba(168, 111, 76, 0.15), 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1; will-change: transform;
            overflow: hidden; /* ç¡®ä¿å†…åµŒé¢æ¿ä¸æº¢å‡º */
        }
        .farm-plot:active { transform: scale(0.95); }
        .farm-plot.locked {
            background: repeating-linear-gradient(45deg, #e0e0e0, #e0e0e0 10px, #d6d6d6 10px, #d6d6d6 20px);
            opacity: 0.8; box-shadow: none;
        }
        .farm-plot.withered {
            background: #a1887f;
            filter: grayscale(1);
        }

        /* å†œç”°ä¿¡æ¯é®ç½© (ä¼˜åŒ–åï¼šåœ†è§’åŒ¹é… + åº•éƒ¨æ»‘å…¥ + éå…¨è¦†ç›–) */
        .plot-info-overlay {
            position: absolute; 
            bottom: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.85); /* æŸ”å’Œç™½åº• */
            backdrop-filter: blur(8px);
            border-radius: 16px; /* å®Œç¾åŒ¹é…å†œç”°åœ†è§’ */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px); /* é»˜è®¤ä¸‹æ²‰ */
            z-index: 20; padding: 4px; text-align: center;
            pointer-events: none;
        }
        
        /* äº¤äº’çŠ¶æ€ï¼šæ˜¾ç¤ºä¿¡æ¯ */
        @media (hover: hover) { 
            .farm-plot:hover .plot-info-overlay { 
                opacity: 1; 
                transform: translateY(0); 
                pointer-events: auto;
            } 
        }
        .farm-plot.show-info .plot-info-overlay { 
            opacity: 1; 
            transform: translateY(0); 
            pointer-events: auto;
        }
        
        .focus-overlay { 
            background: radial-gradient(circle at center, #1d3325 0%, #0f172a 100%); 
            z-index: 9999; 
            opacity: 1;
        }

        /* ç»éªŒæ¡ Tooltip */
        .xp-tooltip {
            position: absolute; top: 110%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 8px 12px; border-radius: 8px;
            font-size: 12px; white-space: nowrap;
            opacity: 0; visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none; z-index: 100;
        }
        .group:hover .xp-tooltip { opacity: 1; visibility: visible; top: 120%; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(74, 124, 89, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        :root { --sky-top: #e0f7fa; --sky-bottom: #ffffff; }
    </style>
</head>
<body class="transition-colors duration-1000">

<div id="app" v-cloak class="h-screen flex flex-col relative overflow-hidden font-sans" @touchstart="initAudioContext">

    <!-- çœŸå®æ—¶é—´å¤©ç©º & å¤©æ°”ç³»ç»Ÿ -->
    <div class="sky-container" :style="skyStyle"></div>
    <div class="weather-layer">
        <!-- é›¨æ»´ç²’å­ -->
        <div v-if="game.weather === 'rain'" v-for="n in 30" :key="'rain'+n" class="rain-particle" 
             :style="{ left: Math.random()*100+'%', animationDuration: 0.5+Math.random()*0.5+'s', animationDelay: Math.random()+'s' }"></div>
        <!-- é›ªèŠ±ç²’å­ -->
        <div v-if="game.weather === 'snow'" v-for="n in 20" :key="'snow'+n" class="snow-particle w-1.5 h-1.5 opacity-80"
             :style="{ left: Math.random()*100+'%', animationDuration: 3+Math.random()*5+'s', animationDelay: Math.random()+'s' }"></div>
    </div>
    <div class="forest-bg" :style="{ filter: `brightness(${brightness})` }"></div>
    <div class="forest-fg" :style="{ filter: `brightness(${brightness * 0.9})` }"></div>
    
    <!-- æ°›å›´ç²’å­ (æ ‘å¶/å…‰æ–‘) -->
    <div v-if="game.weather === 'sunny' || game.weather === 'cloudy'" class="fixed inset-0 pointer-events-none overflow-hidden z-0">
        <div v-for="p in particles" :key="p.id" class="absolute opacity-60 animate-leaf-fall text-forest-300" :style="p.style">
             <span class="text-xl">{{ p.char }}</span>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <!-- ä¼˜åŒ–ï¼šç§»åŠ¨ç«¯å‡å° padding -->
    <nav class="h-16 flex items-center justify-between px-2 sm:px-6 z-50 shrink-0 pt-safe">
        <!-- Logo -->
        <div class="flex items-center gap-2 sm:gap-3 glass-card px-2 sm:px-4 py-1.5 sm:py-2 rounded-full shadow-sm">
            <div class="bg-forest-500 p-1.5 rounded-full text-white shadow-md animate-pulse-slow">
                <i data-lucide="sprout" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-forest-800 font-cute leading-none mt-1 hidden xs:block">è–ªèµ„æ£®æ—</h1>
                <p class="text-[10px] text-forest-600/70 font-bold hidden sm:block">{{ formattedRealTime }}</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-3">
            <!-- å¤©æ°”æŒ‡ç¤ºå™¨ (ç§»åŠ¨ç«¯ä»…å›¾æ ‡) -->
            <button @click="fetchRealWeather" class="flex items-center gap-2 px-2 sm:px-3 py-1.5 rounded-full glass-card border-white/50 hover:bg-white/40 transition-colors" :title="'å½“å‰å¤©æ°”: ' + weatherInfo.desc">
                <i :data-lucide="weatherInfo.icon" class="w-4 h-4 text-sky-600"></i>
                <span class="text-xs font-bold text-sky-700 hidden sm:block">{{ weatherInfo.desc }}</span>
            </button>

            <!-- æ—¶æ®µ/å¤©æ°” Buff -->
            <div v-if="currentBuff.active" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full glass-card border-forest-200">
                <span class="w-2 h-2 rounded-full animate-ping" :class="currentBuff.color"></span>
                <span class="text-xs font-bold text-forest-700">{{ currentBuff.text }}</span>
            </div>

            <!-- èµ„æºæ  (ç§»åŠ¨ç«¯ç´§å‡‘åŒ–) -->
            <div class="flex items-center gap-2 sm:gap-4 glass-card px-2 sm:px-4 py-1 sm:py-1.5 rounded-full shadow-sm">
                <div class="flex items-center gap-1 text-amber-500 font-bold text-xs sm:text-sm" title="é‡‘å¸">
                    <i data-lucide="coins" class="w-3.5 h-3.5 sm:w-4 sm:h-4 fill-amber-400"></i> {{ formatNumber(game.coins) }}
                </div>
                <div class="w-px h-3 bg-forest-200"></div>
                <!-- ç­‰çº§ & ç»éªŒæ¡ -->
                <div class="flex items-center gap-1 text-forest-600 font-bold text-xs sm:text-sm relative group cursor-help">
                    <i data-lucide="crown" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-forest-400"></i> Lv.{{ game.level }}
                    <div class="xp-tooltip flex flex-col gap-1 items-center">
                        <span>ç»éªŒ: {{ game.xp }} / {{ nextLevelXp }}</span>
                        <div class="w-24 h-1.5 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-400" :style="{ width: (game.xp / nextLevelXp * 100) + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ -->
            <div class="sm:hidden flex bg-white/50 rounded-full p-1 border border-white/40 backdrop-blur shadow-sm shrink-0">
                <button @click="viewMode = 'salary'" class="p-1.5 rounded-full transition-all" :class="viewMode === 'salary' ? 'bg-forest-500 text-white shadow-sm' : 'text-forest-600'">
                    <i data-lucide="banknote" class="w-4 h-4"></i>
                </button>
                <button @click="viewMode = 'farm'" class="p-1.5 rounded-full transition-all" :class="viewMode === 'farm' ? 'bg-forest-500 text-white shadow-sm' : 'text-forest-600'">
                    <i data-lucide="trees" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“åŒºåŸŸï¼šåŒæ å¸ƒå±€ -->
    <main class="flex-1 flex overflow-hidden relative p-4 gap-6 z-10 pb-32 sm:pb-24"> 
        
        <!-- å·¦ä¾§ï¼šå·¥èµ„è®°å½• -->
        <section class="flex-1 flex flex-col glass-card rounded-[32px] overflow-hidden transition-all duration-500 transform absolute inset-4 sm:inset-auto sm:relative sm:w-2/5 shadow-sm border-white/60"
                 :class="viewMode === 'salary' ? 'translate-x-0 opacity-100 z-20' : '-translate-x-full opacity-0 z-0 sm:translate-x-0 sm:opacity-100 sm:z-auto'">
            
            <div class="p-6 pb-2 shrink-0">
                <div class="bg-gradient-to-br from-forest-50 to-white rounded-3xl p-5 border border-forest-100 relative overflow-hidden group mb-4 shadow-sm">
                    <div class="absolute -right-6 -top-6 bg-forest-200/50 w-24 h-24 rounded-full blur-xl group-hover:bg-forest-300/50 transition-all"></div>
                    <p class="text-xs text-forest-600 font-bold mb-1 tracking-wider">æœ¬å¹´ç´¯è®¡å®å‘</p>
                    <div class="text-3xl font-black text-forest-800 tracking-tight">{{ formatMoney(salaryStats.yearTotal) }}</div>
                    <div class="text-xs mt-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-forest-100 text-forest-700 font-bold">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> è´¢å¯Œç§¯ç´¯ä¸­
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg text-forest-800 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5 text-forest-500"></i> æ”¶æ”¯æ˜ç»†
                    </h3>
                    <button @click="openSalaryForm()" class="bg-forest-500 hover:bg-forest-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-forest-500/30 flex items-center gap-2 transition-all active:scale-95">
                        <i data-lucide="plus" class="w-4 h-4"></i> è®°ä¸€ç¬”
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-6 pb-6 custom-scroll">
                <div class="space-y-3 pb-4">
                    <div v-for="record in sortedRecords" :key="record.id" 
                         class="bg-white/50 hover:bg-white/80 p-4 rounded-2xl border border-forest-50 hover:border-forest-200 transition-all cursor-pointer group"
                         @click="openSalaryForm(record)">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="font-bold text-lg text-forest-900">{{ formatMoney(record.net) }}</div>
                                <div class="text-xs text-forest-500 font-medium">{{ formatDate(record.date) }} Â· å®å‘</div>
                            </div>
                            <div class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-lg font-bold flex items-center gap-1">
                                +{{ Math.floor(record.net * 0.01 * (isPayDay ? 1.2 : 1)) }} <i data-lucide="coins" class="w-3 h-3"></i>
                            </div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>ç¨å‰: {{ formatNumber(record.gross) }}</span>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity text-forest-500 font-bold">ç¼–è¾‘ ></div>
                        </div>
                    </div>
                    <div v-if="salaryRecords.length === 0" class="text-center py-10 opacity-50 flex flex-col items-center">
                        <div class="w-24 h-24 bg-forest-100 rounded-full flex items-center justify-center mb-4 text-4xl">ğŸƒ</div>
                        <p class="text-sm font-bold text-forest-800">æš‚æ— è®°å½•</p>
                        <p class="text-xs text-forest-600">å¼€å§‹è®°å½•ï¼Œç§ä¸‹è´¢å¯Œçš„ç§å­</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- å³ä¾§ï¼šæˆ‘çš„å†œåœº -->
        <section class="flex-[1.5] flex flex-col glass-card rounded-[32px] overflow-hidden transition-all duration-500 transform absolute inset-4 sm:inset-auto sm:relative sm:w-3/5 shadow-sm border-white/60 z-10"
                 :class="viewMode === 'farm' ? 'translate-x-0 opacity-100 z-20' : 'translate-x-full opacity-0 z-0 sm:translate-x-0 sm:opacity-100 sm:z-auto'">
            
            <div class="p-6 flex justify-between items-start shrink-0">
                <div>
                    <h2 class="text-2xl font-cute text-forest-900 flex items-center gap-2">
                        æˆ‘çš„æ£®æ— <span class="text-xs font-sans px-2 py-0.5 bg-forest-100 text-forest-700 rounded-full font-bold">{{ seasonName }}</span>
                    </h2>
                    <p class="text-xs text-forest-500 mt-1 font-bold flex items-center gap-1" :class="game.marketRate >= 1 ? 'text-rose-500' : 'text-emerald-500'">
                        <i :data-lucide="game.marketRate >= 1 ? 'trending-up' : 'trending-down'" class="w-3 h-3"></i> å¸‚åœºæŒ‡æ•° {{ Math.round(game.marketRate * 100) }}%
                    </p>
                </div>
                
                <div v-if="offlineReport" class="hidden sm:block absolute top-6 left-1/2 -translate-x-1/2 bg-white/90 rounded-2xl p-3 shadow-lg border border-amber-100 animate-pop z-30 flex items-center gap-3">
                    <div>
                        <h4 class="font-bold text-xs text-amber-600 flex items-center gap-1"><i data-lucide="moon" class="w-3 h-3"></i> æ¬¢è¿å›å½’</h4>
                        <p class="text-[10px] text-forest-700 leading-relaxed">
                            ç¦»çº¿ {{ offlineReport.duration }}<br/>
                            <span class="text-emerald-600 font-bold">{{ offlineReport.growth }}</span>
                        </p>
                    </div>
                    <button @click="offlineReport = null" class="p-1 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>

            <!-- å†œç”°åŒºåŸŸ -->
            <div class="flex-1 overflow-y-auto custom-scroll relative p-4" @click="activePlotId = null">
                <div class="min-h-full flex items-center justify-center py-12">
                    <div class="farm-grid max-w-2xl w-full">
                        <div v-for="plot in game.plots" :key="plot.id" 
                             class="farm-plot flex items-center justify-center cursor-pointer group relative select-none"
                             :class="{ 'locked': plot.locked, 'show-info': activePlotId === plot.id, 'withered': plot.withered }"
                             @click.stop="handlePlotClick(plot)">
                            
                            <!-- é”å®š -->
                            <div v-if="plot.locked" class="text-center opacity-60">
                                <i data-lucide="lock" class="w-5 h-5 mx-auto mb-1 text-slate-500"></i>
                                <span class="text-[10px] text-slate-500 font-bold">{{ plot.unlockPrice }}</span>
                            </div>

                            <!-- æ¯è -->
                            <div v-else-if="plot.withered" class="text-center">
                                <span class="text-4xl filter grayscale contrast-50 opacity-80">ğŸ¥€</span>
                                <div class="text-[9px] text-white bg-black/40 px-1 rounded mt-1">å·²æ¯è</div>
                            </div>

                            <!-- ä½œç‰© -->
                            <div v-else-if="plot.cropId" class="w-full h-full flex items-center justify-center relative">
                                <div class="text-4xl sm:text-5xl filter drop-shadow-lg transition-transform duration-500 z-10"
                                     :class="isMature(plot) ? 'animate-float' : ''"
                                     :style="{ transform: `scale(${getGrowthScale(plot)})` }">
                                    {{ getPlantIcon(plot.cropId, plot) }}
                                </div>
                                
                                <!-- è¿›åº¦æ¡ -->
                                <div v-if="!isMature(plot)" class="absolute bottom-2 left-3 right-3 h-1 bg-white/50 rounded-full overflow-hidden z-10">
                                    <div class="h-full bg-forest-500 transition-all duration-1000" :style="{ width: getGrowthPercent(plot) + '%' }"></div>
                                </div>

                                <!-- å€’è®¡æ—¶ (æ˜¾å¼) -->
                                <div v-if="!isMature(plot)" class="absolute top-1 left-1/2 -translate-x-1/2 bg-black/40 text-white text-[9px] px-2 py-0.5 rounded-full backdrop-blur-sm pointer-events-none font-mono tracking-tighter z-30 opacity-90 whitespace-nowrap">
                                    {{ getTimeLeftSimple(plot) }}
                                </div>

                                <!-- æ”¶è·æç¤º -->
                                <div v-if="isMature(plot)" class="absolute -top-2 -right-2 bg-amber-400 text-white p-1 rounded-full shadow-md animate-bounce z-20">
                                    <i data-lucide="check" class="w-3 h-3 stroke-[3]"></i>
                                </div>

                                <!-- å†…åµŒè¯¦æƒ…é¢æ¿ -->
                                <div class="plot-info-overlay">
                                    <div class="text-xs font-bold text-forest-800 mb-1">{{ PLANTS[plot.cropId].name }}</div>
                                    <div class="text-[10px] text-forest-600 mb-1">
                                        {{ isMature(plot) ? 'âœ… å¯æ”¶è·' : 'ğŸŒ± ç”Ÿé•¿ä¸­' }}
                                    </div>
                                    <div class="text-[10px] font-mono bg-forest-100 px-2 py-0.5 rounded text-forest-700">
                                        {{ getTimeLeft(plot) }}
                                    </div>
                                    <div class="mt-2 text-[10px] text-amber-600 font-bold">
                                        é¢„è®¡: {{ getEstimatedProfit(plot) }}
                                    </div>
                                </div>
                            </div>

                            <!-- ç©ºåœ° -->
                            <div v-else class="opacity-0 group-hover:opacity-40 transition-opacity">
                                <i data-lucide="shovel" class="w-8 h-8 text-forest-800/50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å•†åº—æ  -->
            <div class="bg-white/60 border-t border-forest-100 p-4 shrink-0 backdrop-blur-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-forest-800 flex items-center gap-1"><i data-lucide="shopping-bag" class="w-3 h-3"></i> ç§å­å¸‚åœº</h3>
                    <div class="flex gap-1">
                        <button v-for="cat in ['å…¨éƒ¨','é€Ÿç”Ÿ','ç¨€æœ‰']" @click="storeFilter = cat" 
                            class="text-[10px] px-2 py-0.5 rounded-full transition-colors"
                            :class="storeFilter === cat ? 'bg-forest-500 text-white' : 'bg-white text-forest-600'">{{cat}}</button>
                    </div>
                </div>
                <div class="flex gap-3 overflow-x-auto custom-scroll pb-2">
                    <div v-for="plant in filteredPlants" :key="plant.id" 
                         @click="selectSeed(plant.id)"
                         class="flex-shrink-0 w-20 bg-white hover:bg-forest-50 rounded-xl p-2 cursor-pointer border transition-all relative group shadow-sm"
                         :class="[
                            selectedSeed === plant.id ? 'border-forest-500 ring-1 ring-forest-500 bg-forest-50' : 'border-transparent',
                            game.level < plant.level ? 'opacity-50 grayscale' : ''
                         ]">
                        <div class="text-center text-2xl mb-1">{{ plant.icon }}</div>
                        <div class="text-center text-[10px] font-bold truncate text-forest-900">{{ plant.name }}</div>
                        <div class="flex justify-center items-center gap-0.5 mt-1 text-[10px] text-amber-600 font-bold">
                            {{ Math.round(plant.price * game.marketRate) }} <i data-lucide="coins" class="w-2.5 h-2.5"></i>
                        </div>
                        <div v-if="game.level < plant.level" class="absolute inset-0 flex items-center justify-center bg-white/80 rounded-xl text-xs font-bold text-slate-500">
                            Lv.{{ plant.level }}
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- åº•éƒ¨æ‚¬æµ®åŠŸèƒ½å (Dock) -->
    <!-- ç‚¹å‡»å¤–éƒ¨æ”¶èµ·é®ç½© -->
    <div v-if="isDockExpanded" class="fixed inset-0 z-30" @click="isDockExpanded = false"></div>
    
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40 transition-all duration-500 ease-[cubic-bezier(0.19,1,0.22,1)]"
         :class="isDockExpanded ? 'w-[90vw] max-w-md' : 'w-14'">
         
        <div class="bg-white/80 backdrop-blur-2xl border border-white/60 shadow-2xl overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] relative"
             :class="isDockExpanded ? 'rounded-[2rem] h-auto p-3' : 'rounded-full h-14 w-14 hover:scale-110 cursor-pointer flex items-center justify-center'"
             @click.stop="!isDockExpanded && (isDockExpanded = true)">
             
             <div v-if="!isDockExpanded" class="text-forest-600 animate-pop">
                 <i data-lucide="layout-grid" class="w-6 h-6"></i>
             </div>

             <div v-else class="flex justify-between items-center w-full animate-pop">
                 <div class="flex gap-2 flex-1 justify-around">
                     <!-- æ¡£æ¡ˆæŒ‰é’® -->
                     <button @click="handleDockAction('profile')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-slate-50 transition-colors group">
                         <div class="bg-slate-100 p-2.5 rounded-lg text-slate-600 group-hover:bg-slate-500 group-hover:text-white transition-colors"><i data-lucide="user" class="w-5 h-5"></i></div>
                         <span class="text-[10px] font-bold text-forest-800/70">æ¡£æ¡ˆ</span>
                     </button>
                     <button @click="handleDockAction('tasks')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-forest-50 transition-colors relative group">
                         <div class="bg-forest-100 p-2.5 rounded-lg text-forest-600 group-hover:bg-forest-500 group-hover:text-white transition-colors"><i data-lucide="clipboard-list" class="w-5 h-5"></i></div>
                         <span class="text-[10px] font-bold text-forest-800/70">ä»»åŠ¡</span>
                         <span v-if="pendingTasks > 0" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
                     </button>
                     <button @click="handleDockAction('focus')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-emerald-50 transition-colors group">
                         <div class="bg-emerald-100 p-2.5 rounded-lg text-emerald-600 group-hover:bg-emerald-500 group-hover:text-white transition-colors"><i data-lucide="timer" class="w-5 h-5"></i></div>
                         <span class="text-[10px] font-bold text-forest-800/70">ä¸“æ³¨</span>
                     </button>
                     <button @click="handleDockAction('achievements')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-amber-50 transition-colors group">
                         <div class="bg-amber-100 p-2.5 rounded-lg text-amber-600 group-hover:bg-amber-500 group-hover:text-white transition-colors"><i data-lucide="trophy" class="w-5 h-5"></i></div>
                         <span class="text-[10px] font-bold text-forest-800/70">æˆå°±</span>
                     </button>
                     <button @click="handleDockAction('encyclopedia')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-sky-50 transition-colors group">
                         <div class="bg-sky-100 p-2.5 rounded-lg text-sky-600 group-hover:bg-sky-500 group-hover:text-white transition-colors"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                         <span class="text-[10px] font-bold text-forest-800/70">å›¾é‰´</span>
                     </button>
                 </div>
                 <button @click.stop="isDockExpanded = false" class="p-2 ml-2 bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors shrink-0">
                     <i data-lucide="x" class="w-4 h-4"></i>
                 </button>
             </div>
        </div>
    </div>
    
    <!-- ä¸“æ³¨æ¨¡å¼å…¨å±é®ç½© -->
    <div v-if="isFocusing" class="fixed inset-0 z-[9999] focus-overlay flex flex-col items-center justify-center text-white p-4 animate-pop">
        <div class="text-center mb-10">
            <div class="text-6xl font-mono font-bold mb-2 tracking-widest">{{ getFocusDisplayTime() }}</div>
            <p class="text-emerald-400/80 font-bold">ä¸“æ³¨ä¸­...</p>
        </div>
        <div class="relative w-48 h-48 mb-12">
            <div class="absolute inset-0 border-4 border-emerald-900 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-emerald-500 rounded-full animate-spin border-t-transparent" style="animation-duration: 3s"></div>
            <div class="absolute inset-0 flex items-center justify-center text-6xl animate-pulse">ğŸŒ²</div>
        </div>
        <div class="bg-black/50 px-4 py-2 rounded-lg text-xs text-rose-300 mb-8 border border-rose-500/30">
            âš  æ”¾å¼ƒä¸“æ³¨å¯èƒ½å¯¼è‡´ä½œç‰©æ¯è
        </div>
        <p class="text-lg opacity-60 mb-12 italic">"æ”¾ä¸‹æ‰‹æœºï¼Œæ„Ÿå—æ£®æ—çš„å‘¼å¸"</p>
        <button @click="giveUpFocus" class="px-8 py-3 border border-white/20 rounded-full hover:bg-white/10 text-sm opacity-50 hover:opacity-100 transition-all pointer-events-auto">æ”¾å¼ƒä¸“æ³¨</button>
    </div>

    <!-- å¼¹çª—å±‚ -->
    <div v-if="activeModal" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 pb-24" @click.self="activeModal = null">
        <div class="bg-[#fdfbf7] w-full max-w-lg rounded-[32px] p-6 relative animate-pop shadow-2xl max-h-full flex flex-col border border-white/50">
            <button @click="activeModal = null" class="absolute top-4 right-4 p-2 hover:bg-black/5 rounded-full text-slate-400 z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <!-- æ¡£æ¡ˆ (Profile) -->
            <div v-if="activeModal === 'profile'" class="flex flex-col h-full min-h-0">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800 flex-shrink-0"><i data-lucide="user" class="w-6 h-6 text-slate-500"></i> æ¡£æ¡ˆ</h3>
                <div class="space-y-6 overflow-y-auto flex-1 pr-2 custom-scroll">
                    <!-- ä¸ªäººä¿¡æ¯å¡ -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm flex flex-col items-center">
                        <div class="w-20 h-20 bg-forest-100 rounded-full flex items-center justify-center text-4xl mb-3 shadow-inner">ğŸ§‘â€ğŸŒ¾</div>
                        <h4 class="font-bold text-lg text-forest-800">æ£®æ—å®ˆæŠ¤è€…</h4>
                        <div class="flex items-center gap-2 mt-1 text-sm text-slate-500 bg-slate-50 px-3 py-1 rounded-full">
                            <i data-lucide="crown" class="w-4 h-4 text-amber-500"></i> Lv.{{ game.level }}
                        </div>
                        
                        <!-- å‘è–ªæ—¥è®¾ç½® -->
                        <div class="mt-4 flex items-center gap-2 text-sm bg-slate-50 px-3 py-2 rounded-lg border border-slate-100">
                            <span class="text-slate-500">å‘è–ªæ—¥: æ¯æœˆ</span>
                            <input type="number" v-model="game.payDay" min="1" max="31" class="w-12 text-center bg-white border border-slate-200 rounded font-bold text-forest-700 focus:outline-none focus:border-forest-500" @change="saveGame">
                            <span class="text-slate-500">å·</span>
                        </div>
                    </div>

                    <!-- èµ„äº§æ¦‚è§ˆ -->
                    <div>
                        <h5 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">èµ„äº§æ¦‚è§ˆ</h5>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gradient-to-br from-emerald-50 to-white p-4 rounded-2xl border border-emerald-100">
                                <p class="text-xs text-emerald-600 mb-1">ç°å®è´¢å¯Œ (ç´¯è®¡å®å‘)</p>
                                <div class="text-lg font-bold text-emerald-800">{{ formatMoney(salaryStats.yearTotal) }}</div>
                            </div>
                            <div class="bg-gradient-to-br from-amber-50 to-white p-4 rounded-2xl border border-amber-100">
                                <p class="text-xs text-amber-600 mb-1">æ£®æ—è´¢å¯Œ (æ€»èƒ½é‡)</p>
                                <div class="text-lg font-bold text-amber-800">{{ formatNumber(game.lifetimeStats.coins) }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿæ¶¯ç»Ÿè®¡ -->
                    <div>
                        <h5 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">ç”Ÿæ¶¯ç»Ÿè®¡</h5>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center">
                                <div class="text-2xl mb-1">ğŸŒ¾</div>
                                <div class="text-sm font-bold text-slate-700">{{ formatNumber(game.lifetimeStats.harvest) }}</div>
                                <div class="text-[10px] text-slate-400">æ€»æ”¶è·</div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center">
                                <div class="text-2xl mb-1">ğŸ§˜</div>
                                <div class="text-sm font-bold text-slate-700">{{ Math.floor(game.lifetimeStats.focus / 60) }}h</div>
                                <div class="text-[10px] text-slate-400">ä¸“æ³¨æ—¶é•¿</div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center">
                                <div class="text-2xl mb-1">ğŸ¥€</div>
                                <div class="text-sm font-bold text-slate-700">{{ formatNumber(game.lifetimeStats.withered) }}</div>
                                <div class="text-[10px] text-slate-400">æ¯èæ¬¡æ•°</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç§æ¤è®°å½• -->
                    <div>
                        <h5 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">ç§æ¤å›¾è°±</h5>
                        <div class="grid grid-cols-4 gap-2">
                            <div v-for="(count, id) in game.cropStats" :key="id" class="bg-white p-2 rounded-xl border border-slate-50 flex flex-col items-center">
                                <div class="text-xl mb-1">{{ PLANTS[id]?.icon }}</div>
                                <div class="text-[10px] font-bold text-slate-600 text-center truncate w-full">{{ PLANTS[id]?.name }}</div>
                                <div class="text-[10px] text-slate-400">x{{ count }}</div>
                            </div>
                            <div v-if="Object.keys(game.cropStats || {}).length === 0" class="col-span-4 text-center text-xs text-slate-400 py-4 bg-slate-50 rounded-xl">
                                æš‚æ— ç§æ¤è®°å½•
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡ -->
            <div v-if="activeModal === 'tasks'" class="flex flex-col h-full min-h-0">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-forest-800 flex-shrink-0"><i data-lucide="clipboard-list" class="w-6 h-6 text-forest-500"></i> æ¯æ—¥å§”æ‰˜</h3>
                <div class="space-y-3 overflow-y-auto flex-1 pr-2 custom-scroll">
                    <div v-for="task in game.tasks" :key="task.id" class="bg-white rounded-2xl p-4 flex justify-between items-center border border-forest-50 shadow-sm">
                        <div>
                            <p class="font-bold text-sm text-slate-700">{{ task.desc }}</p>
                            <span class="text-xs text-slate-400 font-mono">{{ task.current }}/{{ task.target }}</span>
                        </div>
                        <button @click="claimTask(task)" :disabled="task.claimed || task.current < task.target" class="px-4 py-2 rounded-xl text-xs font-bold transition-all border" :class="task.claimed ? 'bg-slate-100 text-slate-400 border-transparent' : (task.current >= task.target ? 'bg-forest-500 text-white shadow-lg animate-pulse border-forest-500' : 'bg-white border-slate-200 text-slate-400')">
                            {{ task.claimed ? 'å·²å®Œæˆ' : (task.current >= task.target ? 'é¢†å–å¥–åŠ±' : `+${task.reward} èƒ½é‡`) }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- æˆå°± -->
            <div v-if="activeModal === 'achievements'" class="flex flex-col h-full min-h-0">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-amber-700 flex-shrink-0">
                    <i data-lucide="trophy" class="w-6 h-6 text-amber-500"></i> é‡Œç¨‹ç¢‘ 
                    <span class="text-xs bg-amber-100 px-2 py-0.5 rounded-full text-amber-600">{{ game.unlockedAchievements.length }}/{{ achievementsList.length }}</span>
                </h3>
                <div class="space-y-3 overflow-y-auto flex-1 pr-2 custom-scroll">
                    <div v-for="ach in achievementsList" :key="ach.id" class="bg-white rounded-2xl p-4 flex gap-4 border transition-all" :class="isAchievementUnlocked(ach) ? 'border-amber-200 bg-amber-50/50' : 'border-slate-100 opacity-60 grayscale'">
                        <div class="p-3 rounded-2xl h-fit bg-amber-100 text-amber-500"><i :data-lucide="ach.icon" class="w-6 h-6"></i></div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-800">{{ ach.title }}</h4>
                            <p class="text-xs text-slate-500 mt-1">{{ ach.desc }}</p>
                            <div v-if="!isAchievementUnlocked(ach)" class="mt-2 text-xs text-amber-600 font-bold bg-amber-100/50 px-2 py-1 rounded w-fit">è¿›åº¦: {{ formatNumber(getAchievementProgress(ach)) }} / {{ formatNumber(ach.target) }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å›¾é‰´ -->
            <div v-if="activeModal === 'encyclopedia'" class="flex flex-col h-full min-h-0">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-sky-700 flex-shrink-0"><i data-lucide="book-open" class="w-6 h-6 text-sky-500"></i> åšç‰©å¿—</h3>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 shrink-0">
                    <button v-for="cat in ['å…¨éƒ¨', 'è”¬èœ', 'æ°´æœ', 'èŠ±å‰', 'ç¨€æœ‰']" @click="encyclopediaFilter = cat" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap" :class="encyclopediaFilter === cat ? 'bg-sky-500 text-white shadow-md' : 'bg-white border border-slate-200 text-slate-500'">{{ cat }}</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 overflow-y-auto flex-1 pr-2 custom-scroll p-1 content-start">
                    <div v-for="plant in filteredEncyclopedia" :key="plant.id" class="aspect-[3/4] rounded-2xl flex flex-col items-center justify-center p-2 text-center transition-all relative group border bg-white border-slate-200 hover:shadow-lg">
                        <div class="text-4xl mb-2 filter transition-transform group-hover:scale-110" :class="isUnlocked(plant.id) ? '' : 'brightness-0 opacity-20 grayscale'">{{ plant.icon }}</div>
                        <div class="text-xs font-bold w-full truncate" :class="isUnlocked(plant.id) ? 'text-slate-700' : 'text-slate-400'">{{ isUnlocked(plant.id) ? plant.name : '???' }}</div>
                        <div v-if="isUnlocked(plant.id)" class="mt-1 text-[10px] text-slate-400 line-clamp-2 leading-tight">{{ plant.desc }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¥èµ„è¡¨å• -->
    <div v-if="showSalaryForm" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full sm:max-w-lg rounded-t-[32px] sm:rounded-[32px] max-h-[90vh] flex flex-col shadow-2xl animate-pop">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-forest-800">{{ form.id ? 'ç¼–è¾‘è®°å½•' : 'å½•å…¥å·¥èµ„' }}</h3>
                <button @click="showSalaryForm = false" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scroll">
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" v-model="form.date" class="w-full p-3 rounded-xl bg-slate-50 border-transparent focus:bg-white focus:border-forest-500 transition-all outline-none font-mono text-slate-700"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">åŸºæœ¬å·¥èµ„</label><div class="relative"><span class="absolute left-4 top-3.5 text-slate-400 font-bold">Â¥</span><input type="number" v-model.number="form.baseSalary" placeholder="0.00" class="w-full p-3 pl-8 rounded-xl bg-slate-50 border-transparent focus:bg-white focus:border-forest-500 transition-all outline-none font-mono text-lg font-bold text-forest-800"></div></div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-500">å¥–é‡‘è¡¥è´´</label><button @click="addDynamicField('bonuses')" class="text-xs text-forest-600 font-bold flex items-center gap-1 hover:bg-white px-2 py-1 rounded-lg transition-colors"><i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ </button></div>
                    <div class="space-y-2"><div v-for="(item, idx) in form.bonuses" :key="'b'+idx" class="flex gap-2"><input type="text" v-model="item.name" placeholder="åç§°" class="flex-1 p-2 rounded-lg bg-white border border-slate-200 text-sm outline-none"><input type="number" v-model.number="item.amount" placeholder="0" class="w-24 p-2 rounded-lg bg-white border border-slate-200 text-sm outline-none"><button @click="form.bonuses.splice(idx, 1)" class="text-rose-400 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>
                </div>
                <div class="bg-forest-50 rounded-2xl p-5 border border-forest-100 flex justify-between items-center">
                    <div><div class="text-xs text-forest-600 font-bold">é¢„è®¡å®å‘</div><div class="text-2xl font-black text-forest-800 font-mono">{{ formatMoney(computedForm.net) }}</div></div>
                    <div class="text-right"><div class="text-xs text-amber-600 font-bold">å¯è·èƒ½é‡</div><div class="text-sm font-black text-amber-500 flex items-center justify-end gap-1">+{{ Math.floor(computedForm.net * 0.01) }} <i data-lucide="coins" class="w-4 h-4 fill-current"></i></div></div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 flex gap-3">
                <button v-if="form.id" @click="deleteRecord" class="p-3.5 rounded-xl border-2 border-rose-100 text-rose-500 font-bold"><i data-lucide="trash" class="w-5 h-5"></i></button>
                <button @click="submitSalary" class="flex-1 bg-forest-500 hover:bg-forest-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-forest-200 active:scale-95 transition-all text-lg">ç¡®è®¤å½’æ¡£</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="fixed top-24 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4">
        <transition-group name="list">
            <div v-for="t in toasts" :key="t.id" class="bg-white/90 backdrop-blur-md border border-forest-100 px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 pointer-events-auto transform transition-all duration-300">
                <div class="p-2 rounded-full" :class="t.type === 'error' ? 'bg-rose-100 text-rose-500' : 'bg-forest-100 text-forest-600'"><i :data-lucide="t.icon" class="w-5 h-5"></i></div>
                <div><div class="font-bold text-sm text-slate-800">{{ t.title }}</div><div class="text-xs text-slate-500">{{ t.msg }}</div></div>
            </div>
        </transition-group>
    </div>

</div>

<script>
const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

const TIME_SCALE = 1;

// 50+ æ¤ç‰©æ•°æ®åº“ (å‘½åä¼˜åŒ–)
const PLANTS_DB = [
    { id: 'p1', name: 'é€Ÿç”Ÿèåœ', icon: 'ğŸ¥•', type: 'è”¬èœ', rarity: 'common', level: 1, time: 5, price: 10, sell: 20, desc: 'ç”Ÿé•¿è¿…é€Ÿï¼Œé€‚åˆæ–°æ‰‹ç»ƒæ‰‹ã€‚' },
    { id: 'p2', name: 'ç¿¡ç¿ ç™½èœ', icon: 'ğŸ¥¬', type: 'è”¬èœ', rarity: 'common', level: 1, time: 10, price: 15, sell: 28, desc: 'æ¸…è„†çˆ½å£ï¼Œç«é”…å¿…å¤‡ã€‚' },
    { id: 'p3', name: 'é»„é‡‘åœŸè±†', icon: 'ğŸ¥”', type: 'è”¬èœ', rarity: 'common', level: 2, time: 15, price: 20, sell: 35, desc: 'åŸ‹åœ¨åœŸé‡Œçš„é»„é‡‘ã€‚' },
    { id: 'p4', name: 'çº¢ç¯ç¬¼ç•ªèŒ„', icon: 'ğŸ…', type: 'è”¬èœ', rarity: 'common', level: 2, time: 20, price: 25, sell: 45, desc: 'çº¢å½¤å½¤çš„ï¼Œåƒå°ç¯ç¬¼ã€‚' },
    { id: 'p5', name: 'ç´«æ°´æ™¶èŒ„å­', icon: 'ğŸ†', type: 'è”¬èœ', rarity: 'common', level: 3, time: 30, price: 30, sell: 55, desc: 'ç´«è‰²çš„å¤–è¡£ä¸‹æ˜¯æŸ”è½¯çš„å¿ƒã€‚' },
    { id: 'p11', name: 'åˆæ‹è‰è“', icon: 'ğŸ“', type: 'æ°´æœ', rarity: 'uncommon', level: 5, time: 60, price: 50, sell: 120, desc: 'ç”œç¾çš„åˆæ‹å‘³é“ã€‚' },
    { id: 'p12', name: 'ç´«éœè‘¡è„', icon: 'ğŸ‡', type: 'æ°´æœ', rarity: 'uncommon', level: 6, time: 90, price: 60, sell: 150, desc: 'ä¸€ä¸²ä¸²ç´«è‰²çš„å®çŸ³ã€‚' },
    { id: 'p21', name: 'å¸Œæœ›å‘æ—¥è‘µ', icon: 'ğŸŒ»', type: 'èŠ±å‰', rarity: 'common', level: 4, time: 45, price: 40, sell: 80, desc: 'æ°¸è¿œè¿½éšå¤ªé˜³çš„è„šæ­¥ã€‚' },
    { id: 'p22', name: 'çœŸçˆ±ç«ç‘°', icon: 'ğŸŒ¹', type: 'èŠ±å‰', rarity: 'rare', level: 10, time: 240, price: 150, sell: 400, desc: 'çˆ±æƒ…çš„è±¡å¾ï¼Œå¸¦åˆºçš„ç¾ä¸½ã€‚' },
    { id: 'p41', name: 'å¹¸è¿å››å¶è‰', icon: 'ğŸ€', type: 'ç¨€æœ‰', rarity: 'epic', level: 20, time: 600, price: 500, sell: 1500, desc: 'ä¼ è¯´ä¸­èƒ½å¸¦æ¥å¥½è¿ã€‚' },
    { id: 'p42', name: 'æ‘‡é’±æ ‘', icon: 'ğŸŒ²', type: 'ç¨€æœ‰', rarity: 'legendary', level: 30, time: 1440, price: 2000, sell: 8000, desc: 'æ‘‡ä¸€æ‘‡ï¼Œé‡‘å¸æ‰ä¸‹æ¥ã€‚' },
];

const generateMorePlants = () => {
    const emojis = ['ğŸ¥¦','ğŸŒ½','ğŸ§…','ğŸ§„','ğŸ¥œ','ğŸ„','ğŸ¥‘','ğŸ¥','ğŸ‰','ğŸ‹','ğŸ‘','ğŸ’','ğŸŒ·','ğŸŒº','ğŸŒ¸','ğŸŒµ','ğŸŒ´','ğŸ','ğŸ‚','ğŸŒ¾','ğŸª·','ğŸ’','ğŸª´','ğŸƒ','ğŸŒ¿','â˜˜ï¸','ğŸ','ğŸ‹','ğŸªµ','ğŸª¨','ğŸ„','ğŸŒ°','ğŸ¥œ','ğŸ','ğŸ¥','ğŸ¥–','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ'];
    const names = ['è¥¿å…°èŠ±å«å£«', 'é˜³å…‰ç‰ç±³', 'æ´‹è‘±éª‘å£«', 'å¤§è’œå®ˆå«', 'èŠ±ç”Ÿå®å®', 'é­”åŠ›çº¢è‡', 'æ£®æ—é³„æ¢¨', 'å¥‡å¼‚æœå­', 'å¤æ—¥ç“œç‹', 'é…¸ç”œæŸ æª¬', 'èœœæ¡ƒå…¬ä¸»', 'çº¢æ¨±æ¡ƒ', 'éƒé‡‘é¦™', 'æ‰¶æ¡‘èŠ±', 'æ¨±èŠ±é›¨', 'æ²™æ¼ ä»™äººæŒ', 'æ¤°å­æ ‘', 'çº¢æ«å¶', 'è½å¶å½’æ ¹', 'ä¸°æ”¶éº¦ç©—', 'ç¡è²', 'ç™¾èŠ±æŸ', 'ç›†æ ½ç²¾çµ', 'é£ä¹‹å¶', 'è‰è¯', 'ä¸‰å¶è‰', 'ç«¹å­', 'è®¸æ„¿æ ‘', 'åŸæœ¨', 'çµçŸ³', 'æ¯’è˜‘è‡', 'æ¿æ —', 'å¼€å¿ƒæœ', 'å…¨éº¦é¢åŒ…', 'ç‰›è§’åŒ…', 'æ³•æ£', 'å¥¶é…ªå—', 'é‡‘é¸¡è›‹', 'ç…è›‹', 'é»„æ²¹'];
    return emojis.map((e, i) => ({
        id: `gen_${i}`,
        name: names[i] || `ç¥ç§˜æ¤ç‰© ${i+1}`,
        icon: e,
        type: i % 3 === 0 ? 'è”¬èœ' : (i % 3 === 1 ? 'æ°´æœ' : 'èŠ±å‰'),
        rarity: i % 5 === 0 ? 'rare' : 'common',
        level: Math.floor(i/3) + 1,
        time: (i+1) * 15,
        price: (i+1) * 20,
        sell: (i+1) * 45,
        desc: 'æ£®æ—æ·±å¤„æœªè¢«è®°å½•çš„ç¥ç§˜ç‰©ç§ã€‚'
    }));
};

const FULL_PLANTS = [...PLANTS_DB, ...generateMorePlants()];

const generateAchievements = () => {
    const list = [];
    [10, 50, 100, 500, 1000].forEach((t, i) => list.push({ id: `harvest_${t}`, title: `ä¸°æ”¶ä¹‹ç¥ ${['I','II','III','IV','V'][i]}`, desc: `ç´¯è®¡æ”¶è· ${t} æ¬¡ä½œç‰©`, target: t, type: 'lifetime_harvest', icon: 'sprout' }));
    [1000, 5000, 10000, 50000, 100000].forEach((t, i) => list.push({ id: `wealth_${t}`, title: `è´¢å¯Œå¯†ç  ${['I','II','III','IV','V'][i]}`, desc: `æŒæœ‰èƒ½é‡è¾¾åˆ° ${t}`, target: t, type: 'current_coins', icon: 'gem' }));
    [5, 10, 20, 30, 40, 50].forEach((t, i) => list.push({ id: `col_${t}`, title: `åšç‰©å­¦å®¶ ${['I','II','III','IV','V','VI'][i]}`, desc: `è§£é” ${t} ä¸ªå›¾é‰´`, target: t, type: 'encyclopedia_count', icon: 'book' }));
    [5, 10, 20, 30, 50].forEach((t, i) => list.push({ id: `lvl_${t}`, title: `æ£®æ—é¢†ä¸» ${['I','II','III','IV','V'][i]}`, desc: `æ£®æ—ç­‰çº§ Lv.${t}`, target: t, type: 'level', icon: 'crown' }));
    [30, 60, 120, 300, 600].forEach((t, i) => list.push({ id: `focus_${t}`, title: `å¿ƒæµå¤§å¸ˆ ${['I','II','III','IV','V'][i]}`, desc: `ç´¯è®¡ä¸“æ³¨ ${t} åˆ†é’Ÿ`, target: t, type: 'lifetime_focus', icon: 'brain-circuit' }));
    list.push({ id: 'wither_1', title: 'è¦†æ°´éš¾æ”¶', desc: 'ç¬¬ä¸€æ¬¡æ¯è', target: 1, type: 'lifetime_withered', icon: 'alert-triangle' });
    list.push({ id: 'wither_10', title: 'ç ´çª—æ•ˆåº”', desc: 'ç´¯è®¡æ¯è 10 æ¬¡', target: 10, type: 'lifetime_withered', icon: 'alert-triangle' });
    return list;
};
const ACHIEVEMENTS_DEF = generateAchievements();

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const playTone = (freq, type = 'sine', duration = 0.1) => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
};

createApp({
    setup() {
        const now = ref(Date.now());
        const viewMode = ref('salary');
        const game = reactive({
            coins: 500, level: 1, xp: 0,
            plots: Array(16).fill(null).map((_, i) => ({ id: i, locked: i > 3, unlockPrice: (i-2)*500, cropId: null, plantedAt: 0, withered: false })),
            inventory: {}, unlockedEncyclopedia: ['p1'], marketRate: 1.0, lastSaveTime: Date.now(),
            lifetimeStats: { coins: 0, harvest: 0, focus: 0, withered: 0 },
            cropStats: {}, 
            tasks: [], lastTaskDate: '', unlockedAchievements: [],
            payDay: 15, weather: 'sunny', weatherCode: 0
        });
        
        const salaryRecords = ref([]);
        const form = reactive({ id: null, date: new Date().toISOString().split('T')[0], baseSalary: null, bonuses: [], deductions: [] });
        const showSalaryForm = ref(false);
        const activeModal = ref(null);
        const storeFilter = ref('å…¨éƒ¨');
        const encyclopediaFilter = ref('å…¨éƒ¨');
        const selectedSeed = ref(null);
        const toasts = ref([]);
        const offlineReport = ref(null);
        const isFocusing = ref(false);
        const focusTime = ref(25);
        const focusEndTime = ref(0);
        const soundEnabled = ref(true);
        const isDockExpanded = ref(false);
        const activePlotId = ref(null);
        const weatherInfo = ref({ desc: 'æ™´æœ—', icon: 'sun' });

        // Computed
        const realDate = computed(() => new Date(now.value));
        const formattedRealTime = computed(() => realDate.value.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}));
        const hour = computed(() => realDate.value.getHours());
        const month = computed(() => realDate.value.getMonth());
        
        const skyStyle = computed(() => {
            const h = hour.value + realDate.value.getMinutes()/60;
            // å¤©æ°”å½±å“å¤©ç©ºé¢œè‰²
            if (game.weather === 'rain') return { '--sky-top': '#607d8b', '--sky-bottom': '#cfd8dc' };
            if (h >= 6 && h < 18) return { '--sky-top': '#e0f7fa', '--sky-bottom': '#ffffff' }; 
            return { '--sky-top': '#263238', '--sky-bottom': '#37474f' };
        });
        const brightness = computed(() => {
            if (game.weather === 'rain' || game.weather === 'snow') return 0.8;
            return (hour.value >= 6 && hour.value < 18) ? 1 : 0.7;
        });
        const celestialRotation = computed(() => ((hour.value + realDate.value.getMinutes()/60) / 24) * 360 - 180);
        const seasonName = computed(() => [2,3,4].includes(month.value) ? 'æ˜¥' : [5,6,7].includes(month.value) ? 'å¤' : [8,9,10].includes(month.value) ? 'ç§‹' : 'å†¬');
        
        const currentBuff = computed(() => {
            if (game.weather === 'rain') return { active: true, text: 'é›¨æ°´æ»‹æ¶¦: ç”Ÿé•¿+30%', color: 'bg-blue-400' };
            if (game.weather === 'snow') return { active: true, text: 'ç‘é›ªå…†ä¸°å¹´: äº§é‡UP', color: 'bg-white' };
            if (realDate.value.getDate() === game.payDay) return { active: true, text: 'å‘è–ªæ—¥: è½¬åŒ–+20%', color: 'bg-rose-400' };
            if (hour.value >= 6 && hour.value < 9) return { active: true, text: 'æ™¨è€•: ç»éªŒUP', color: 'bg-emerald-400' };
            if (hour.value >= 18 && hour.value < 21) return { active: true, text: 'æ™šå¸‚: å”®ä»·UP', color: 'bg-amber-400' };
            return { active: false };
        });

        const isPayDay = computed(() => realDate.value.getDate() === game.payDay);
        const PLANTS = computed(() => FULL_PLANTS.reduce((acc, p) => { acc[p.id] = p; return acc; }, {}));
        const sortedRecords = computed(() => [...salaryRecords.value].sort((a,b) => new Date(b.date) - new Date(a.date)));
        
        const filteredPlants = computed(() => {
            let list = FULL_PLANTS;
            if (storeFilter.value === 'é€Ÿç”Ÿ') list = list.filter(p => p.time <= 30);
            if (storeFilter.value === 'ç¨€æœ‰') list = list.filter(p => ['rare','epic','legendary'].includes(p.rarity));
            return list.sort((a,b) => a.level - b.level);
        });

        const filteredEncyclopedia = computed(() => {
            if (encyclopediaFilter.value === 'å…¨éƒ¨') return FULL_PLANTS;
            return FULL_PLANTS.filter(p => p.type === encyclopediaFilter.value || (encyclopediaFilter.value === 'ç¨€æœ‰' && p.rarity !== 'common'));
        });

        const unlockedCount = computed(() => game.unlockedEncyclopedia.length);
        const pendingTasks = computed(() => game.tasks.filter(t => !t.claimed && t.current >= t.target).length);
        const computedForm = computed(() => {
            const bonusTotal = form.bonuses.reduce((s, i) => s + (i.amount || 0), 0);
            const deductTotal = form.deductions.reduce((s, i) => s + (i.amount || 0), 0);
            const gross = (form.baseSalary || 0) + bonusTotal;
            return { gross, net: gross - deductTotal };
        });
        const salaryStats = computed(() => {
            const yearTotal = salaryRecords.value.reduce((s, r) => s + r.net, 0);
            const insuranceTotal = salaryRecords.value.reduce((s, r) => s + (r.insurance || 0), 0);
            return { yearTotal, insuranceTotal };
        });
        const particles = computed(() => {
            const chars = ['ğŸƒ','âœ¨','ğŸŒ¼'];
            return Array.from({length: 12}).map((_,i) => ({ id: i, char: chars[i%chars.length], style: { left: (i*8)+'%', animationDuration: (8+i%5)+'s', animationDelay: (i%3)+'s' } }));
        });
        const achievementsList = computed(() => ACHIEVEMENTS_DEF);
        const nextLevelXp = computed(() => game.level * 500);

        const initAudioContext = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playSound = (type) => {
            if(!soundEnabled.value) return;
            initAudioContext();
            if(type === 'click') playTone(400, 'sine', 0.05);
            if(type === 'success') { playTone(600, 'sine', 0.1); setTimeout(()=>playTone(800, 'sine', 0.2), 100); }
            if(type === 'harvest') { playTone(800, 'triangle', 0.1); }
            if(type === 'error') playTone(200, 'sawtooth', 0.2);
            if(type === 'wither') { playTone(150, 'sawtooth', 0.4); }
        };
        const toggleSound = () => { soundEnabled.value = !soundEnabled.value; };

        // å¤©æ°”ç³»ç»Ÿ
        const fetchRealWeather = async () => {
            if (!navigator.geolocation) return showToast('æ— æ³•å®šä½', 'æµè§ˆå™¨ä¸æ”¯æŒå®šä½', 'map-pin', 'error');
            
            showToast('æ­£åœ¨è·å–å¤©æ°”...', 'è¯·ç¨å€™', 'cloud');
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const { latitude, longitude } = pos.coords;
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                    const data = await res.json();
                    
                    const code = data.current_weather.weathercode;
                    game.weatherCode = code;
                    
                    // WMO code mapping
                    if (code <= 3) { game.weather = 'sunny'; weatherInfo.value = { desc: 'æ™´æœ—', icon: 'sun' }; }
                    else if (code <= 48) { game.weather = 'cloudy'; weatherInfo.value = { desc: 'å¤šäº‘', icon: 'cloud' }; }
                    else if (code <= 67 || (code >= 80 && code <= 82)) { game.weather = 'rain'; weatherInfo.value = { desc: 'é›¨å¤©', icon: 'cloud-rain' }; }
                    else if (code >= 71) { game.weather = 'snow'; weatherInfo.value = { desc: 'é›ªå¤©', icon: 'snowflake' }; }
                    
                    showToast('å¤©æ°”å·²æ›´æ–°', `å½“å‰ï¼š${weatherInfo.value.desc}`, weatherInfo.value.icon);
                    saveGame();
                } catch (e) {
                    showToast('è·å–å¤±è´¥', 'ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å¤©æ°”', 'wifi-off', 'error');
                }
            }, () => {
                showToast('å®šä½å¤±è´¥', 'è¯·å…è®¸å®šä½æƒé™ä»¥è·å–å¤©æ°”', 'map-pin-off', 'error');
            });
        };

        const openSalaryForm = (record = null) => {
            playSound('click');
            if (record) { Object.assign(form, JSON.parse(JSON.stringify(record))); form.bonuses = record.bonuses || []; form.deductions = record.deductions || []; }
            else { Object.assign(form, { id: null, date: new Date().toISOString().split('T')[0], baseSalary: null, bonuses: [{name:'ç»©æ•ˆ',amount:null}], deductions: [{name:'ç¤¾ä¿',ratio:0.08,amount:null}] }); }
            showSalaryForm.value = true;
        };

        const addDynamicField = () => form.bonuses.push({ name: '', amount: null });
        const removeDynamicField = (t, i) => form.bonuses.splice(i, 1);
        const autoCalcDeductions = () => { form.deductions.forEach(d => { if(d.ratio) d.amount = parseFloat(((form.baseSalary||0)*d.ratio).toFixed(2)); }); };
        
        const submitSalary = () => {
            if (!form.baseSalary) { playSound('error'); return showToast('é”™è¯¯', 'è¯·è¾“å…¥åŸºæœ¬å·¥èµ„', 'alert-circle', 'error'); }
            const record = { id: form.id || Date.now(), date: form.date, baseSalary: form.baseSalary, bonuses: form.bonuses, deductions: form.deductions, net: computedForm.value.net, gross: computedForm.value.gross, insurance: form.deductions.reduce((s,i)=>s+(i.amount||0),0) };
            if(form.id) { const idx = salaryRecords.value.findIndex(r => r.id === form.id); if(idx!==-1) salaryRecords.value[idx] = record; }
            else { salaryRecords.value.unshift(record); const reward = Math.floor(record.net * 0.01); game.coins += reward; game.lifetimeStats.coins += reward; playSound('success'); showToast('å½’æ¡£æˆåŠŸ', `è·å¾— ${reward} èƒ½é‡`, 'banknote'); }
            showSalaryForm.value = false; saveGame();
        };

        const deleteRecord = (id) => { if(confirm('åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) { salaryRecords.value = salaryRecords.value.filter(r => r.id !== id); showSalaryForm.value = false; saveGame(); } };

        const selectSeed = (id) => {
            playSound('click');
            const p = PLANTS.value[id];
            if(game.level < p.level) return showToast('ç­‰çº§ä¸è¶³', `éœ€Lv.${p.level}`, 'lock', 'error');
            if(game.coins < p.price) return showToast('èƒ½é‡ä¸è¶³', 'å»è®°è´¦å§', 'coins', 'error');
            selectedSeed.value = selectedSeed.value === id ? null : id;
        };

        const checkLevelUp = () => {
            while (game.xp >= nextLevelXp.value) {
                game.xp -= nextLevelXp.value;
                game.level++;
                playSound('success');
                showToast('å‡çº§å•¦ï¼', `å½“å‰ç­‰çº§ Lv.${game.level}`, 'crown');
            }
        };

        const handlePlotClick = (plot) => {
             if (plot.cropId && !isMature(plot) && !plot.withered) {
                if (activePlotId.value === plot.id) activePlotId.value = null; else activePlotId.value = plot.id;
                return; 
            }
            if(plot.locked) {
                if(game.coins >= plot.unlockPrice) { game.coins -= plot.unlockPrice; plot.locked = false; playSound('success'); showToast('æ‰©å»ºæˆåŠŸ', 'æ£®æ—å˜å¤§äº†', 'sprout'); saveGame(); }
                else { playSound('error'); showToast('èƒ½é‡ä¸è¶³', `éœ€ ${plot.unlockPrice}`, 'lock', 'error'); }
                return;
            }
            if(plot.withered) {
                 plot.cropId = null; plot.withered = false; playSound('click'); showToast('æ¸…ç†å®Œæˆ', 'æ¯èä½œç‰©å·²ç§»é™¤', 'trash'); saveGame(); return;
            }
            if(plot.cropId && isMature(plot)) {
                const p = PLANTS.value[plot.cropId];
                const profit = Math.round(p.sell * game.marketRate);
                game.coins += profit; 
                game.xp += Math.round(p.price / 2); 
                
                game.lifetimeStats.harvest++; game.lifetimeStats.coins += profit;
                if(!game.cropStats) game.cropStats = {};
                game.cropStats[p.id] = (game.cropStats[p.id] || 0) + 1;

                updateTask('harvest'); updateTask('earn', profit);
                if(!game.unlockedEncyclopedia.includes(p.id)) { game.unlockedEncyclopedia.push(p.id); showToast('å›¾é‰´è§£é”', p.name, 'book-open'); }
                
                checkLevelUp(); 
                
                plot.cropId = null; playSound('harvest'); showToast('æ”¶è·', `+${profit}`, 'coins'); checkAchievements(); saveGame(); return;
            }
            if(!plot.cropId && selectedSeed.value) {
                const p = PLANTS.value[selectedSeed.value];
                if(game.coins >= p.price) { game.coins -= p.price; plot.cropId = p.id; plot.plantedAt = Date.now(); playSound('click'); saveGame(); }
                else { playSound('error'); showToast('èƒ½é‡ä¸è¶³', 'æ— æ³•ç§æ¤', 'coins', 'error'); }
            }
        };

        const startFocus = () => { isFocusing.value = true; focusEndTime.value = Date.now() + focusTime.value * 60 * 1000; playSound('success'); };
        const giveUpFocus = () => {
            isFocusing.value = false;
            if (Math.random() < 0.5) {
                 const growingPlots = game.plots.filter(p => p.cropId && !isMature(p) && !p.withered);
                 if (growingPlots.length > 0) {
                     const victim = growingPlots[Math.floor(Math.random() * growingPlots.length)];
                     victim.withered = true;
                     game.lifetimeStats.withered++;
                     playSound('wither');
                     showToast('ä¸“æ³¨å¤±è´¥', 'ä¸€ä¸ªä½œç‰©æ¯èäº†...', 'alert-triangle', 'error');
                     checkAchievements();
                 }
            } else {
                showToast('ä¸“æ³¨ä¸­æ–­', 'å¹¸å¥½æ²¡æœ‰ä½œç‰©å—åˆ°å½±å“', 'info');
            }
            saveGame();
        };
        const getFocusDisplayTime = () => {
            if(!isFocusing.value) return '00:00';
            const left = Math.max(0, Math.floor((focusEndTime.value - now.value) / 1000));
            if(left === 0 && isFocusing.value) { 
                isFocusing.value = false; 
                const reward = focusTime.value * 5; 
                game.coins += reward; 
                game.lifetimeStats.focus += focusTime.value; 
                
                // ç”Ÿé•¿åŠ é€Ÿå¥–åŠ±
                const bonusTime = focusTime.value * 60 * 1000 * 0.5; 
                game.plots.forEach(p => {
                    if (p.cropId && !p.withered && !isMature(p)) {
                        p.plantedAt -= bonusTime;
                    }
                });

                updateTask('focus', focusTime.value); updateTask('earn', reward); 
                checkAchievements(); playSound('success'); 
                showToast('ä¸“æ³¨å®Œæˆï¼', `ç”Ÿé•¿åŠ é€Ÿ & +${reward} èƒ½é‡`, 'trophy'); 
                saveGame();
            }
            const m = Math.floor(left / 60).toString().padStart(2,'0'); const s = (left % 60).toString().padStart(2,'0'); return `${m}:${s}`;
        };

        const handleDockAction = (action) => { if (action === 'focus') startFocus(); else activeModal.value = action; isDockExpanded.value = false; };
        const generateDailyTasks = () => { if (game.lastTaskDate !== new Date().toDateString()) { game.tasks = [{ id: 1, desc: 'æ”¶è· 3 æ¬¡', target: 3, current: 0, reward: 50, type: 'harvest', claimed: false }, { id: 2, desc: 'èµšå– 100 èƒ½é‡', target: 100, current: 0, reward: 30, type: 'earn', claimed: false }]; game.lastTaskDate = new Date().toDateString(); } };
        const updateTask = (type, amt=1) => { game.tasks.forEach(t => { if(t.type===type && !t.claimed) t.current += amt; }); };
        const claimTask = (t) => { if(!t.claimed && t.current >= t.target) { game.coins += t.reward; t.claimed = true; playSound('success'); showToast('ä»»åŠ¡å®Œæˆ', `+${t.reward}`, 'check'); saveGame(); } };
        
        const isAchievementUnlocked = (ach) => game.unlockedAchievements.includes(ach.id);
        const getAchievementProgress = (ach) => {
            if(ach.type === 'lifetime_coins') return game.lifetimeStats.coins;
            if(ach.type === 'lifetime_harvest') return game.lifetimeStats.harvest;
            if(ach.type === 'encyclopedia_count') return game.unlockedEncyclopedia.length;
            if(ach.type === 'level') return game.level;
            if(ach.type === 'lifetime_focus') return game.lifetimeStats.focus;
            if(ach.type === 'lifetime_withered') return game.lifetimeStats.withered || 0;
            return 0;
        };
        const checkAchievements = () => { ACHIEVEMENTS_DEF.forEach(ach => { if(!isAchievementUnlocked(ach) && getAchievementProgress(ach) >= ach.target) { game.unlockedAchievements.push(ach.id); playSound('success'); showToast('æˆå°±è¾¾æˆ', ach.title, 'trophy'); } }); };

        // è¾…åŠ© - å¤©æ°”å½±å“ç”Ÿé•¿
        const getGrowthRate = () => {
            if (game.weather === 'rain') return 1.3; // é›¨å¤©åŠ é€Ÿ30%
            return 1.0;
        };

        const isMature = (p) => { if (!p.cropId) return false; return (now.value - p.plantedAt) * getGrowthRate() >= PLANTS.value[p.cropId].time * 60 * 1000; };
        const getGrowthPercent = (p) => { 
            if (!p.cropId) return 0; 
            const total = PLANTS.value[p.cropId].time * 60 * 1000;
            const elapsed = (now.value - p.plantedAt) * getGrowthRate();
            return Math.min(100, (elapsed / total) * 100); 
        };
        const getGrowthScale = (p) => 0.3 + (getGrowthPercent(p)/100)*0.7;
        const getPlantIcon = (id) => PLANTS.value[id]?.icon || 'ğŸŒ±';
        const getTimeLeft = (p) => {
            if(!p.cropId) return '';
            const total = PLANTS.value[p.cropId].time * 60 * 1000; 
            const elapsed = (now.value - p.plantedAt) * getGrowthRate();
            const leftMs = (total - elapsed) / getGrowthRate();
            const left = Math.ceil(leftMs/60000);
            return left > 0 ? `${left}åˆ†` : 'æˆç†Ÿ';
        };
        const getTimeLeftSimple = (p) => { 
            if(!p.cropId) return ''; 
            const total = PLANTS.value[p.cropId].time * 60 * 1000;
            const elapsed = (now.value - p.plantedAt) * getGrowthRate();
            const diff = (total - elapsed) / getGrowthRate();
            if(diff<=0) return ''; 
            const m=Math.floor(diff/60000); const s=Math.floor((diff%60000)/1000); 
            return `${m}:${s.toString().padStart(2,'0')}`; 
        };
        const getEstimatedProfit = (p) => { if(!p.cropId) return 0; return Math.round(PLANTS.value[p.cropId].sell * game.marketRate); };
        const isUnlocked = (id) => game.unlockedEncyclopedia.includes(id);
        const formatMoney = (n) => 'Â¥' + (n||0).toLocaleString('en-US', {minimumFractionDigits: 2});
        const formatNumber = (n) => (n||0).toLocaleString();
        const formatDate = (d) => new Date(d).toLocaleDateString();
        const formatDuration = (ms) => Math.ceil(ms/60000) + 'åˆ†é’Ÿ';
        const showToast = (title, msg, icon, type='info') => { const id = Date.now(); toasts.value.push({id, title, msg, icon, type}); setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000); };

        let saveTimeout;
        const saveGame = () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { game.lastSaveTime = Date.now(); localStorage.setItem('salary_forest_final', JSON.stringify({ game, records: salaryRecords.value })); }, 1000); };
        const loadGame = () => {
            const d = localStorage.getItem('salary_forest_final');
            if(d) {
                const p = JSON.parse(d);
                Object.assign(game, p.game);
                salaryRecords.value = p.records || [];
                const offlineMin = (Date.now() - game.lastSaveTime) / 60000;
                if(offlineMin > 10) {
                    let count = 0;
                    game.plots.forEach(p => { if(p.cropId && !isMature(p) && !p.withered && (p.plantedAt + PLANTS.value[p.cropId].time*60000 <= Date.now())) count++; });
                    if(count > 0 || offlineMin > 60) offlineReport.value = { duration: Math.floor(offlineMin/60)+'å°æ—¶', growth: count > 0 ? `${count}ä½œç‰©æˆç†Ÿ` : 'æ£®æ—ç”Ÿé•¿ä¸­' };
                }
            }
            generateDailyTasks();
        };

        onMounted(() => { 
            loadGame(); 
            setInterval(() => {
                now.value = Date.now();
                // å¸‚åœºæ³¢åŠ¨é€»è¾‘
                if (Math.random() < 0.005) { // ä½æ¦‚ç‡å˜åŠ¨
                     game.marketRate = 0.8 + Math.random() * 0.5;
                }
            }, 1000); 
            watch(game, saveGame, { deep: true }); 
            nextTick(() => lucide.createIcons()); 
        });
        
        watch(activeModal, () => nextTick(() => lucide.createIcons()));

        return {
            viewMode, game, salaryRecords, salaryStats, sortedRecords,
            filteredPlants, filteredEncyclopedia, selectedSeed, toasts, showSalaryForm, activeModal,
            form, computedForm, storeFilter, encyclopediaFilter, unlockedCount, pendingTasks,
            formattedRealTime, skyStyle, celestialRotation, seasonName, currentBuff, isPayDay, brightness, particles, offlineReport, achievementsList, PLANTS, PLANTS_ARR: FULL_PLANTS, nextLevelXp, weatherInfo,
            openSalaryForm, addDynamicField, removeDynamicField, autoCalcDeductions, submitSalary, deleteRecord,
            handlePlotClick, selectSeed, isMature, getGrowthPercent, getGrowthScale, getPlantIcon, getTimeLeft, getTimeLeftSimple, getEstimatedProfit, isUnlocked, isAchievementUnlocked, getAchievementProgress, claimTask,
            formatMoney, formatNumber, formatDate, formatDuration, editRecord: (r) => openSalaryForm(r),
            startFocus, giveUpFocus, getFocusDisplayTime, isFocusing, toggleSound, soundEnabled,
            isDockExpanded, handleDockAction, initAudioContext, activePlotId, fetchRealWeather
        };
    }
}).mount('#app');
</script>
</body>
</html>